version: 2.1

orbs:
  rok8s: fairwinds/rok8s-scripts@14

executors:
  golang-exec:
    docker:
      - image: cimg/go:1.25
  goreleaser:
    resource_class: large
    docker:
      - image: goreleaser/goreleaser:v2.13.1
  ci-images:
    docker:
      - image: quay.io/reactiveops/ci-images:v14.1-bullseye
  ci-images-large:
    resource_class: large
    docker:
      - image: quay.io/reactiveops/ci-images:v14.1-bullseye

references:
  e2e_configuration: &e2e_configuration
    pre_script: e2e/pre-e2e.sh
    script: e2e/run-e2e.sh
    command_runner_image: quay.io/reactiveops/ci-images:v14.1-bullseye
    requires:
      - test
      - lint
      - build_docker
    filters:
      branches:
        only: /.*/
      tags:
        ignore: /.*/

  install_vault_alpine: &install_vault_alpine
    run:
      name: install hashicorp vault
      command: |
        apk --update add curl yq
        cd /tmp
        curl -LO https://releases.hashicorp.com/vault/1.12.2/vault_1.12.2_linux_amd64.zip
        sha256sum vault_1.12.2_linux_amd64.zip | grep 116c143de377a77a7ea455a367d5e9fe5290458e8a941a6e2dd85d92aaedba67
        unzip vault_1.12.2_linux_amd64.zip
        mv vault /usr/bin/vault

jobs:
  test:
    executor: golang-exec
    steps:
      - checkout
      - run:
          name: Go Mod Download
          command: go mod download
      - run:
          name: Run Tests
          command: go test -v -race -coverprofile=coverage.out ./...
      - run:
          name: Build Binary
          command: go build -o helm-release-pruner ./cmd/pruner

  lint:
    executor: golang-exec
    steps:
      - checkout
      - run:
          name: Install golangci-lint
          command: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
      - run:
          name: Run Linter
          command: golangci-lint run --timeout 5m

  build_docker:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker Image
          command: docker build -t helm-release-pruner:test .

  push_docker:
    working_directory: /home/circleci/src/github.com/fairwindsops/helm-release-pruner
    docker:
      - image: quay.io/reactiveops/ci-images:v14-alpine
    resource_class: large
    shell: /bin/bash
    steps:
      - checkout
      - setup_remote_docker
      - *install_vault_alpine
      - rok8s/get_vault_env:
          vault_path: repo/global/env
      - rok8s/set_env
      - rok8s/docker_login:
          username: $FAIRWINDS_QUAY_USER
          password-variable: FAIRWINDS_QUAY_TOKEN
      - rok8s/docker_build:
          config: .circleci/build.config
      - rok8s/docker_push:
          config: .circleci/build.config

  # Single release job (like insights-cli): goreleaser publishes to GitHub Releases, Quay Docker, and Homebrew.
  # Requires in vault (repo/global/env or repo/helm-release-pruner/env): GITHUB_TOKEN, FAIRWINDS_QUAY_USER, FAIRWINDS_QUAY_TOKEN.
  release:
    working_directory: /home/circleci/project
    resource_class: large
    shell: /bin/bash
    docker:
      - image: goreleaser/goreleaser:v2.13.1
    steps:
      - checkout
      - *install_vault_alpine
      - rok8s/get_vault_env:
          vault_path: repo/global/env
      - rok8s/set_env
      - setup_remote_docker:
          version: docker27
      - rok8s/docker_login:
          registry: "quay.io"
          username: $FAIRWINDS_QUAY_USER
          password-variable: FAIRWINDS_QUAY_TOKEN
      - run: echo 'export GORELEASER_CURRENT_TAG="${CIRCLE_TAG}"' >> $BASH_ENV
      - run: goreleaser release --clean

workflows:
  version: 2
  ci:
    jobs:
      - test
      - lint
      - build_docker:
          requires:
            - test
            - lint
      - rok8s/kubernetes_e2e_tests:
          name: "e2e-kubernetes-1.33"
          kind_node_image: "kindest/node:v1.33.0"
          executor:
            name: ci-images-large
          <<: *e2e_configuration
      - rok8s/kubernetes_e2e_tests:
          name: "e2e-kubernetes-1.34"
          kind_node_image: "kindest/node:v1.34.0"
          executor:
            name: ci-images-large
          <<: *e2e_configuration
      - rok8s/kubernetes_e2e_tests:
          name: "e2e-kubernetes-1.35"
          kind_node_image: "kindest/node:v1.35.0"
          executor:
            name: ci-images-large
          <<: *e2e_configuration
      - push_docker:
          requires:
            - e2e-kubernetes-1.33
            - e2e-kubernetes-1.34
            - e2e-kubernetes-1.35
          context: org-global
          filters:
            branches:
              ignore:
                - /pull\/[0-9]+/

  release:
    jobs:
      - release:
          context: org-global
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
